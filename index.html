<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Interview Prep</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      background-color: #0f172a;
      overflow-x: hidden;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function InterviewPrepPlatform() {
      const [apiKey, setApiKey] = useState('');
      const [isApiKeySet, setIsApiKeySet] = useState(false);
      const [context, setContext] = useState(`DevSecOps Architect role at Marathon Petroleum - a large energy company modernizing their development practices. They have low maturity: manual deployments, inconsistent source control, security as afterthought. Looking for someone who can build CI/CD pipelines, influence without authority, and work with .NET/Azure.`);
      const [currentQuestion, setCurrentQuestion] = useState('');
      const [isRecording, setIsRecording] = useState(false);
      const [transcript, setTranscript] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [isGeneratingQuestion, setIsGeneratingQuestion] = useState(false);
      const [questionHistory, setQuestionHistory] = useState([]);
      const [conversationHistory, setConversationHistory] = useState([]);
      const [swotAnalysis, setSwotAnalysis] = useState(null);
      const [isQuestionComplete, setIsQuestionComplete] = useState(false);
      const [mode, setMode] = useState('setup');
      const [error, setError] = useState('');
      
      const recognitionRef = useRef(null);
      const finalTranscriptRef = useRef('');
      const conversationEndRef = useRef(null);

      useEffect(() => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognitionRef.current = new SpeechRecognition();
          recognitionRef.current.continuous = true;
          recognitionRef.current.interimResults = true;
          recognitionRef.current.lang = 'en-US';
          
          recognitionRef.current.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = finalTranscriptRef.current;
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcriptText = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcriptText + ' ';
                finalTranscriptRef.current = finalTranscript;
              } else {
                interimTranscript += transcriptText;
              }
            }
            
            setTranscript(finalTranscript + interimTranscript);
          };
          
          recognitionRef.current.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed') {
              setError('Microphone access denied. Please enable microphone permissions in your browser settings.');
            } else if (event.error === 'no-speech') {
              // Restart recognition if no speech detected
              if (isRecording) {
                recognitionRef.current.start();
              }
            }
          };

          recognitionRef.current.onend = () => {
            // Auto-restart if still in recording mode
            if (isRecording && recognitionRef.current) {
              try {
                recognitionRef.current.start();
              } catch (e) {
                console.log('Recognition already started');
              }
            }
          };
        }
        
        return () => {
          if (recognitionRef.current) {
            recognitionRef.current.stop();
          }
        };
      }, [isRecording]);

      useEffect(() => {
        if (conversationEndRef.current) {
          conversationEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [conversationHistory, swotAnalysis]);

      const callAnthropicAPI = async (messages) => {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01",
            "anthropic-dangerous-direct-browser-access": "true"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1500,
            messages: messages
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `API error: ${response.status}`);
        }

        return response.json();
      };

      const generateQuestion = async () => {
        setIsGeneratingQuestion(true);
        setError('');
        setConversationHistory([]);
        setSwotAnalysis(null);
        setIsQuestionComplete(false);
        
        try {
          const historyContext = questionHistory.length > 0 
            ? `\n\nPrevious questions asked (do not repeat these):\n${questionHistory.map((q, i) => `${i + 1}. ${q}`).join('\n')}`
            : '';
          
          const data = await callAnthropicAPI([
            {
              role: "user",
              content: `You are a critical but professional .NET engineer interviewing a candidate for the following role:

${context}
${historyContext}

Generate ONE challenging technical interview question. Be specific and scenario-based. The question should test practical knowledge, not just theory. Keep the question concise (2-4 sentences max).

Respond with ONLY the question, no preamble or explanation.`
            }
          ]);

          const question = data.content
            .filter(item => item.type === "text")
            .map(item => item.text)
            .join("");
          
          setCurrentQuestion(question);
          setQuestionHistory(prev => [...prev, question]);
          setConversationHistory([{ role: 'interviewer', content: question }]);
          setMode('question');
        } catch (err) {
          setError(`Failed to generate question: ${err.message}`);
          console.error(err);
        } finally {
          setIsGeneratingQuestion(false);
        }
      };

      const startRecording = () => {
        if (!recognitionRef.current) {
          setError('Speech recognition not supported in this browser. Please use Chrome.');
          return;
        }
        
        setError('');
        finalTranscriptRef.current = '';
        setTranscript('');
        setIsRecording(true);
        setMode('recording');
        
        try {
          recognitionRef.current.start();
        } catch (e) {
          console.log('Recognition start error:', e);
        }
      };

      const handleDone = async () => {
        if (recognitionRef.current) {
          recognitionRef.current.stop();
        }
        setIsRecording(false);
        setIsLoading(true);
        
        const currentTranscript = transcript.trim() || finalTranscriptRef.current.trim();
        
        if (!currentTranscript) {
          setError('No speech detected. Please try again.');
          setIsLoading(false);
          setMode('question');
          return;
        }
        
        const updatedHistory = [...conversationHistory, { role: 'candidate', content: currentTranscript }];
        setConversationHistory(updatedHistory);
        setTranscript('');
        
        try {
          const conversationText = updatedHistory
            .map(entry => `${entry.role === 'interviewer' ? 'Interviewer' : 'Candidate'}: ${entry.content}`)
            .join('\n\n');

          const data = await callAnthropicAPI([
            {
              role: "user",
              content: `You are a critical but professional .NET engineer interviewing a candidate. Your tone should be challenging while remaining cordial. If something is wrong or vague, point it out directly.

Role Context:
${context}

Conversation so far:
${conversationText}

Evaluate the candidate's most recent answer. You must respond in this EXACT JSON format:

{
  "isComplete": true/false,
  "feedback": "Your direct feedback on their answer - what was good, what was weak or vague, what was missing. Keep it under 100 words.",
  "followUp": "If isComplete is false, provide a pointed follow-up question that probes deeper into weaknesses. If isComplete is true, leave this empty string."
}

Set "isComplete" to true ONLY when:
- The candidate has given a thorough, specific answer with concrete examples
- You have asked 2-3 follow-up questions and received adequate responses
- There are no major gaps or vagueness left to probe

Set "isComplete" to false if:
- The answer is vague or lacks specific technical details
- You haven't yet probed key weaknesses
- There are obvious gaps that need exploration

Respond with ONLY the JSON object, no other text.`
            }
          ]);

          let responseText = data.content
            .filter(item => item.type === "text")
            .map(item => item.text)
            .join("");
          
          responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const evaluation = JSON.parse(responseText);
          
          const feedbackEntry = { 
            role: 'interviewer', 
            content: evaluation.feedback + (evaluation.followUp ? `\n\n${evaluation.followUp}` : ''),
            isFollowUp: !evaluation.isComplete
          };
          
          setConversationHistory(prev => [...prev, feedbackEntry]);
          
          if (evaluation.isComplete) {
            setIsQuestionComplete(true);
            await generateSwotAnalysis([...updatedHistory, feedbackEntry]);
          }
          
          setMode('question');
        } catch (err) {
          setError(`Failed to get feedback: ${err.message}`);
          console.error(err);
          setMode('question');
        } finally {
          setIsLoading(false);
        }
      };

      const generateSwotAnalysis = async (fullConversation) => {
        try {
          const conversationText = fullConversation
            .map(entry => `${entry.role === 'interviewer' ? 'Interviewer' : 'Candidate'}: ${entry.content}`)
            .join('\n\n');

          const data = await callAnthropicAPI([
            {
              role: "user",
              content: `Analyze this interview exchange and provide a SWOT analysis of the candidate's performance.

Role Context:
${context}

Full Conversation:
${conversationText}

Provide a SWOT analysis in this EXACT JSON format:

{
  "strengths": ["strength 1", "strength 2", "strength 3"],
  "weaknesses": ["weakness 1", "weakness 2", "weakness 3"],
  "opportunities": ["opportunity to improve 1", "opportunity 2", "opportunity 3"],
  "threats": ["threat/risk 1", "threat 2", "threat 3"]
}

Guidelines:
- Strengths: What the candidate demonstrated well - technical knowledge, communication, examples given
- Weaknesses: Gaps in knowledge, vague answers, missed opportunities to elaborate
- Opportunities: Specific ways to improve the answer for next time - additional points to make, better examples to use, clearer structure
- Threats: Things that could hurt their chances - red flags raised, incorrect statements, areas where interviewer seemed skeptical

Keep each item concise (under 20 words). Provide exactly 3 items per category.

Respond with ONLY the JSON object, no other text.`
            }
          ]);

          let responseText = data.content
            .filter(item => item.type === "text")
            .map(item => item.text)
            .join("");
          
          responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const swot = JSON.parse(responseText);
          setSwotAnalysis(swot);
        } catch (err) {
          console.error('Failed to generate SWOT:', err);
          setError('Failed to generate SWOT analysis.');
        }
      };

      const nextQuestion = () => {
        setTranscript('');
        setCurrentQuestion('');
        setConversationHistory([]);
        setSwotAnalysis(null);
        setIsQuestionComplete(false);
        generateQuestion();
      };

      const resetSession = () => {
        setMode('setup');
        setCurrentQuestion('');
        setTranscript('');
        setConversationHistory([]);
        setQuestionHistory([]);
        setSwotAnalysis(null);
        setIsQuestionComplete(false);
        setError('');
      };

      const speakText = (text) => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          window.speechSynthesis.speak(utterance);
        }
      };

      // API Key Entry Screen
      if (!isApiKeySet) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 flex items-center justify-center">
            <div className="max-w-md w-full space-y-6">
              <div className="text-center">
                <h1 className="text-2xl font-bold text-blue-400 mb-2">Interview Prep</h1>
                <p className="text-slate-400 text-sm">Enter your Anthropic API key to begin</p>
              </div>
              
              <div className="bg-slate-800 border border-slate-600 rounded-lg p-4 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Anthropic API Key
                  </label>
                  <input
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    className="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-blue-500"
                    placeholder="sk-ant-..."
                  />
                </div>
                
                <p className="text-xs text-slate-500">
                  Your API key is stored only in memory and never saved. Get your key at{' '}
                  <a href="https://console.anthropic.com" target="_blank" rel="noopener noreferrer" className="text-blue-400 underline">
                    console.anthropic.com
                  </a>
                </p>
                
                <button
                  onClick={() => setIsApiKeySet(true)}
                  disabled={!apiKey.startsWith('sk-')}
                  className="w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg font-semibold transition-colors"
                >
                  Continue
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-900 text-white p-4">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="text-center mb-6">
              <h1 className="text-2xl font-bold text-blue-400 mb-2">Interview Prep</h1>
              <p className="text-slate-400 text-sm">Record your answer, press Done when finished</p>
            </div>

            {error && (
              <div className="bg-red-900/50 border border-red-500 text-red-200 p-3 rounded-lg mb-4 text-sm">
                {error}
                <button onClick={() => setError('')} className="float-right text-red-300 hover:text-white">‚úï</button>
              </div>
            )}

            {/* Setup Mode */}
            {mode === 'setup' && (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    Interview Context
                  </label>
                  <textarea
                    value={context}
                    onChange={(e) => setContext(e.target.value)}
                    className="w-full h-40 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white text-sm resize-none focus:outline-none focus:border-blue-500"
                    placeholder="Describe the role, company, and any specific requirements..."
                  />
                </div>
                
                <button
                  onClick={generateQuestion}
                  disabled={isGeneratingQuestion || !context.trim()}
                  className="w-full py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg font-semibold text-lg transition-colors"
                >
                  {isGeneratingQuestion ? 'Generating Question...' : 'Start Interview'}
                </button>
              </div>
            )}

            {/* Conversation View */}
            {(mode === 'question' || mode === 'recording') && (
              <div className="space-y-4">
                {/* Conversation History */}
                <div className="space-y-3 max-h-96 overflow-y-auto hide-scrollbar">
                  {conversationHistory.map((entry, index) => (
                    <div 
                      key={index}
                      className={`rounded-lg p-4 ${
                        entry.role === 'interviewer' 
                          ? 'bg-slate-800 border border-slate-600' 
                          : 'bg-slate-700 border border-slate-500 ml-4'
                      }`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <span className={`text-xs font-medium ${
                          entry.role === 'interviewer' ? 'text-blue-400' : 'text-green-400'
                        }`}>
                          {entry.role === 'interviewer' ? 'INTERVIEWER' : 'YOUR ANSWER'}
                        </span>
                        {entry.role === 'interviewer' && (
                          <button
                            onClick={() => speakText(entry.content)}
                            className="text-slate-400 hover:text-white text-xs"
                          >
                            üîä
                          </button>
                        )}
                      </div>
                      <p className="text-white text-sm leading-relaxed whitespace-pre-wrap">{entry.content}</p>
                    </div>
                  ))}
                  
                  {isLoading && (
                    <div className="bg-slate-800 border border-slate-600 rounded-lg p-4">
                      <div className="flex items-center">
                        <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <span className="ml-3 text-slate-400 text-sm">Analyzing your answer...</span>
                      </div>
                    </div>
                  )}
                  <div ref={conversationEndRef} />
                </div>

                {/* SWOT Analysis */}
                {swotAnalysis && (
                  <div className="bg-slate-800 border-2 border-amber-500 rounded-lg p-4">
                    <h3 className="text-amber-400 font-bold text-center mb-4">SWOT ANALYSIS</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {/* Strengths */}
                      <div className="bg-green-900/30 border border-green-700 rounded-lg p-3">
                        <h4 className="text-green-400 font-semibold text-sm mb-2">üí™ Strengths</h4>
                        <ul className="space-y-1">
                          {swotAnalysis.strengths.map((item, i) => (
                            <li key={i} className="text-green-200 text-xs">‚Ä¢ {item}</li>
                          ))}
                        </ul>
                      </div>
                      
                      {/* Weaknesses */}
                      <div className="bg-red-900/30 border border-red-700 rounded-lg p-3">
                        <h4 className="text-red-400 font-semibold text-sm mb-2">‚ö†Ô∏è Weaknesses</h4>
                        <ul className="space-y-1">
                          {swotAnalysis.weaknesses.map((item, i) => (
                            <li key={i} className="text-red-200 text-xs">‚Ä¢ {item}</li>
                          ))}
                        </ul>
                      </div>
                      
                      {/* Opportunities */}
                      <div className="bg-blue-900/30 border border-blue-700 rounded-lg p-3">
                        <h4 className="text-blue-400 font-semibold text-sm mb-2">üéØ Opportunities</h4>
                        <ul className="space-y-1">
                          {swotAnalysis.opportunities.map((item, i) => (
                            <li key={i} className="text-blue-200 text-xs">‚Ä¢ {item}</li>
                          ))}
                        </ul>
                      </div>
                      
                      {/* Threats */}
                      <div className="bg-purple-900/30 border border-purple-700 rounded-lg p-3">
                        <h4 className="text-purple-400 font-semibold text-sm mb-2">üö® Threats</h4>
                        <ul className="space-y-1">
                          {swotAnalysis.threats.map((item, i) => (
                            <li key={i} className="text-purple-200 text-xs">‚Ä¢ {item}</li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                )}

                {/* Recording Area */}
                {!isQuestionComplete && !isLoading && (
                  <div className="bg-slate-800 border border-slate-600 rounded-lg p-4">
                    {mode === 'recording' && (
                      <>
                        <div className="flex justify-between items-center mb-3">
                          <span className="text-xs text-green-400 font-medium">YOUR ANSWER</span>
                          <span className="flex items-center text-red-400 text-xs">
                            <span className="w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span>
                            Recording...
                          </span>
                        </div>
                        <div className="min-h-20 mb-4 text-slate-300 text-sm leading-relaxed">
                          {transcript || <span className="text-slate-500 italic">Speak your answer...</span>}
                        </div>
                      </>
                    )}

                    {mode === 'question' && (
                      <button
                        onClick={startRecording}
                        className="w-full py-4 bg-green-600 hover:bg-green-700 active:bg-green-800 rounded-lg font-semibold text-lg transition-colors"
                      >
                        üé§ {conversationHistory.length > 1 ? 'Continue Answer' : 'Start Recording'}
                      </button>
                    )}

                    {mode === 'recording' && (
                      <button
                        onClick={handleDone}
                        className="w-full py-6 bg-amber-600 hover:bg-amber-700 active:bg-amber-800 rounded-lg font-bold text-xl transition-colors"
                      >
                        ‚úì DONE
                      </button>
                    )}
                  </div>
                )}

                {/* Next Question Button */}
                {isQuestionComplete && swotAnalysis && (
                  <div className="flex gap-3">
                    <button
                      onClick={nextQuestion}
                      className="flex-1 py-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 rounded-lg font-semibold transition-colors"
                    >
                      Next Question ‚Üí
                    </button>
                    <button
                      onClick={resetSession}
                      className="px-6 py-4 bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded-lg font-semibold transition-colors"
                    >
                      Reset
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* Progress Indicator */}
            {questionHistory.length > 0 && (
              <div className="mt-6 text-center text-slate-500 text-sm">
                Questions completed: {questionHistory.length - (isQuestionComplete ? 0 : 1)} | Current exchanges: {Math.floor(conversationHistory.length / 2)}
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InterviewPrepPlatform />);
  </script>
</body>
</html>
